<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Herramientas Organizacionales</title>
    <link rel="stylesheet" href="assets/css/main.css?v=2.4">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .search-wrapper {
            position: relative;
            flex-grow: 1;
            max-width: 500px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-container">
                <div class="header-titles">
                    <h1>üèõÔ∏è Sistema de Herramientas Organizacionales</h1>
                    <p>Gobierno del Estado de Chihuahua</p>
                </div>



                <!-- Men√∫ de Usuario -->
                <div class="user-menu-container">
                    <div class="profile-trigger" onclick="window.mostrarModalPerfil()">
                        <div class="profile-avatar" id="user-avatar-initials">?</div>
                        <div class="profile-info">
                            <span class="profile-name" id="user-display-name">Usuario</span>
                            <span class="profile-role" id="user-display-role">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="nav">
            <button class="nav-btn active" onclick="mostrarVista('dashboard', event)">üìä Reporte General</button>
            <button class="nav-btn" onclick="mostrarVista('organizaciones', event)">üè¢ Dependencia/Entidad</button>
            <button class="nav-btn" onclick="mostrarVista('herramientas', event)">üíº Herramientas</button>
            <!-- <button class="nav-btn" onclick="mostrarVista('expedientes', event)">üìÅ Expedientes</button> -->
            <button class="nav-btn" id="nav-btn-cargas" style="display: none;"
                onclick="mostrarVista('cargas', event)">üìà Cargas de Trabajo</button>
            <button class="nav-btn" onclick="mostrarVista('reportes', event)">üì• Exportar</button>
            <button class="nav-btn" id="nav-btn-usuarios" style="display: none;"
                onclick="mostrarVista('usuarios', event)">üë• Usuarios</button>
            <button class="nav-btn logout" onclick="window.AppUtils.cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alert-container"></div>

        <!-- VISTAS -->

        <!-- Vista Reporte General -->
        <div id="vista-dashboard">
            <div id="dashboard-drilldown-header" class="hidden mb-20"
                style="display: flex; align-items: center; gap: 20px;">
                <button class="btn-back" onclick="regresarTableroGlobal()"
                    style="background: linear-gradient(135deg, #4A90E2 0%, #003DA5 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
                    ‚¨ÖÔ∏è Regresar al Resumen
                </button>
                <h2 id="dashboard-drilldown-title" class="card-title" style="margin: 0; flex-grow: 1;">Resumen por
                    Sector</h2>
                <button id="btn-exportar-sector-pdf" class="btn btn-secondary" onclick="window.descargarPDFSector()"
                    style="display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                    üì• Exportar Sector a PDF
                </button>
            </div>

            <h2 id="dashboard-main-title" class="card-title mb-20 text-center">Tablero de Control - Herramientas
                Organizacionales</h2>

            <!-- Bloques Principales (Trapecios) -->
            <div class="dashboard-trapecios-grid" id="trapecios-grid">
                <div class="trapecio-wrapper" onclick="interactuarDashboard('centralizado')">
                    <div class="trapecio-card trapecio-azul">
                        <div class="trapecio-content">
                            <i class="icon-org">üè¢</i>
                            <h3>Centralizado</h3>
                            <p>Sector Centralizado del Gobierno</p>
                            <div class="trapecio-count" id="count-centralizado">0 dependencias</div>
                        </div>
                    </div>
                </div>
                <div class="trapecio-wrapper" onclick="interactuarDashboard('paraestatal')">
                    <div class="trapecio-card trapecio-morado">
                        <div class="trapecio-content">
                            <i class="icon-org">üè≠</i>
                            <h3>Paraestatal</h3>
                            <p>Sector Paraestatal</p>
                            <div class="trapecio-count" id="count-paraestatal">0 entidades</div>
                        </div>
                    </div>
                </div>
                <div class="trapecio-wrapper" onclick="interactuarDashboard('autonomo')">
                    <div class="trapecio-card trapecio-oscuro">
                        <div class="trapecio-content">
                            <i class="icon-org">üèõÔ∏è</i>
                            <h3>Aut√≥nomos</h3>
                            <p>Organismos Aut√≥nomos</p>
                            <div class="trapecio-count" id="count-autonomo">0 dependencias</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado General (Barras de Progreso) -->
            <div class="card mt-30" id="estado-general-card">
                <div class="card-header">
                    <h3 class="card-title">üìà Estado General de Herramientas Organizacionales</h3>
                </div>
                <div class="p-20" id="estado-general-bars">
                    <!-- Din√°mico: Secci√≥n Centralizada, Paraestatal, etc. con sus 4 barras -->
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="dashboard-sections" id="dashboard-sections">
                <!-- Section: Centralizado -->
                <div class="dashboard-section-card" id="list-centralizado-section">
                    <div class="section-header-custom header-centralizado">Dependencias (Centralizado)</div>
                    <div class="section-body-custom" id="list-centralizado">
                        <div class="spinner"></div>
                    </div>
                </div>
                <!-- Section: Paraestatal -->
                <div class="dashboard-section-card" id="list-paraestatal-section">
                    <div class="section-header-custom header-paraestatal">Entidades (Paraestatal)</div>
                    <div class="section-body-custom" id="list-paraestatal">
                        <div class="spinner"></div>
                    </div>
                </div>
                <!-- Section: Aut√≥nomos -->
                <div class="dashboard-section-card" id="list-autonomo-section">
                    <div class="section-header-custom header-autonomo">Organismos Aut√≥nomos</div>
                    <div class="section-body-custom" id="list-autonomo">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <!-- Tarjetas de Resumen (Grid 2 columnas) -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px;">

                <!-- Resumen de Expedientes -->
                <div class="card" id="resumen-expedientes-card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Resumen de Expedientes</h3>
                    </div>
                    <div class="card-body">
                        <div id="resumen-expedientes-content">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Indicadores Clave (KPIs) -->
                <div class="card" id="kpis-card">
                    <div class="card-header">
                        <h3 class="card-title">üéØ Indicadores Clave</h3>
                    </div>
                    <div class="card-body">
                        <div id="kpis-content">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Vista Dependencias/Entidades -->
        <div id="vista-organizaciones" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Dependencias y Entidades</h3>
                    <div id="admin-actions-organizaciones" style="display: none;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="mostrarModal('modal-nueva-organizacion')">‚ûï Nueva
                                Dependencia/Entidad</button>
                            <button class="btn btn-secondary" onclick="window.abrirModalImportar('organizaciones')">üì•
                                Importar Excel</button>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="padding: 10px 20px;">
                    <select class="form-select" id="filtro-tipo-org" onchange="cargarOrganizaciones()">
                        <option value="">Todas</option>
                        <option value="DEPENDENCIA">Dependencias</option>
                        <option value="ENTIDAD_PARAESTATAL">Entidades Paraestatales</option>
                    </select>
                </div>
                <div id="tabla-organizaciones">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Titular</th>
                                    <th>Sem√°foro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="organizaciones-tabla-body">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Herramientas -->
        <div id="vista-herramientas" class="hidden">
            <div class="layout-herramientas">
                <!-- Izquierda: Lista -->
                <div class="card" style="flex: 1; min-width: 300px;">
                    <div class="card-header">
                        <h3 class="card-title">Seleccionar Dependencia</h3>
                    </div>
                    <div class="p-10">
                        <input type="text" class="form-input mb-10" id="buscar-org-herramientas"
                            placeholder="Buscar dependencia..." oninput="filtrarOrganizacionesHerramientas()">
                        <div id="lista-organizaciones-herramientas" class="list-group">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <!-- Derecha: Detalle -->
                <div class="card" style="flex: 4; min-width: 400px; display: flex; flex-direction: column;">
                    <div class="card-header" style="justify-content: space-between;">
                        <h3 class="card-title" id="titulo-dependencia-seleccionada">Herramientas</h3>
                        <div id="admin-actions-herramientas" style="display: none;">
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="mostrarModalNuevaHerramienta()">‚ûï Nueva
                                    Herramienta</button>
                                <button class="btn btn-secondary" onclick="window.abrirModalImportar('herramientas')">üì•
                                    Importar Excel</button>
                            </div>
                        </div>
                    </div>
                    <div id="detalle-herramientas-dependencia" class="p-20" style="flex: 1; overflow-y: auto;">
                        <div class="empty-state">
                            <p>Seleccione una dependencia de la lista para ver su informaci√≥n y herramientas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Exportar -->
        <div id="vista-reportes" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Reportes y Exportaciones</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" style="cursor: pointer;"
                        onclick="window.ReportesModule.exportarInventario()">
                        <div class="stat-number" style="color: var(--azul-institucional);">üìã</div>
                        <div class="stat-label">Inventario Completo</div>
                        <button class="btn btn-primary mt-20">Exportar Excel</button>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="window.ReportesModule.exportarSemaforo()">
                        <div class="stat-number" style="color: var(--morado-institucional);">üö¶</div>
                        <div class="stat-label">Reporte de Sem√°foro</div>
                        <button class="btn btn-secondary mt-20">Exportar Excel</button>
                    </div>
                    <div class="stat-card" style="cursor: pointer;"
                        onclick="window.ReportesModule.exportarProximasVencer()">
                        <div class="stat-number" style="color: var(--amarillo-advertencia);">‚è∞</div>
                        <div class="stat-label">Pr√≥ximas a Vencer</div>
                        <button class="btn btn-secondary mt-20">Exportar Excel</button>
                    </div>
                </div>
                <div class="card mt-20">
                    <div class="card-header">
                        <h3 class="card-title">Historial de Cambios</h3>
                    </div>
                    <div id="tabla-historial">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="admin-maintenance-section" class="card mt-20"
                    style="display: none; border: 1px solid #ffccd5; background: #fff5f5;">
                    <div class="card-header">
                        <h3 class="card-title" style="color: #d32f2f;">‚öôÔ∏è Mantenimiento del Sistema</h3>
                    </div>
                    <div class="p-20">
                        <p class="mb-20"><strong>Zona de Peligro:</strong> Esta acci√≥n eliminar√° permanentemente todas
                            las dependencias, herramientas e historial. El usuario administrador no ser√° eliminado.</p>
                        <button class="btn" style="background-color: #d32f2f; color: white;"
                            onclick="window.resetearBaseDeDatos()">Eliminar Todo y Empezar de Cero</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Usuarios (Admin Only) -->
        <div id="vista-usuarios" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Administraci√≥n de Usuarios</h3>
                    <button class="btn btn-primary" onclick="window.mostrarModalNuevoUsuario()">‚ûï Nuevo Usuario</button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-tabla-body">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vista Expedientes -->
        <div id="vista-expedientes" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìÅ Gesti√≥n de Expedientes y Avances</h3>
                    <button id="btn-nuevo-expediente" class="btn btn-primary" style="display: none;"
                        onclick="mostrarModalNuevoExpediente()">‚ûï Nuevo Expediente</button>
                </div>
                <div class="p-20">
                    <div id="expedientes-lista" class="expedientes-grid">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Cargas de Trabajo -->
        <div id="vista-cargas" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà Cargas de Trabajo y Productividad</h3>
                </div>
                <div class="p-20">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Herramientas</th>
                                    <th>Expedientes</th>
                                    <th>√öltima Actividad</th>
                                </tr>
                            </thead>
                            <tbody id="cargas-tabla-body">
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- FIN CONTAINER -->

    <!-- MODALES (Top Level) -->

    <!-- Modal Perfil -->
    <div id="modal-perfil" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Mi Perfil</h3>
                <button class="modal-close" onclick="cerrarModal('modal-perfil')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card mb-20" style="background: var(--gris-claro);">
                    <div class="p-20 text-center">
                        <div class="profile-avatar"
                            style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 15px;">üë§</div>
                        <h4 id="perfil-nombre" class="mb-5">Cargando...</h4>
                        <p id="perfil-email" class="text-muted mb-10">...</p>
                        <span id="perfil-rol-badge" class="badge">...</span>
                    </div>
                </div>
                <h4 class="mb-15">Cambiar Contrase√±a</h4>
                <form onsubmit="window.handleCambioPassword(event)">
                    <div class="form-group">
                        <label class="form-label">Contrase√±a Actual</label>
                        <input type="password" class="form-input" id="pwd-actual" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nueva Contrase√±a</label>
                        <input type="password" class="form-input" id="pwd-nuevo" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Actualizar Contrase√±a</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Admin Usuarios (Nuevo/Editar) -->
    <div id="modal-usuario-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title" id="usuario-modal-title">Registrar Usuario</h3>
                <button class="modal-close" onclick="cerrarModal('modal-usuario-admin')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-usuario-admin" onsubmit="window.handleGuardarUsuario(event)">
                    <input type="hidden" id="admin-user-id">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" name="nombre_completo" id="admin-user-nombre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Correo Electr√≥nico</label>
                        <input type="email" class="form-input" name="email" id="admin-user-email" required>
                    </div>
                    <div class="form-group" id="container-pwd-admin">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-input" name="password" id="admin-user-pwd" minlength="4">
                        <small class="text-muted">Si est√°s editando, deja en blanco para no cambiar.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rol</label>
                        <select class="form-select" name="rol" id="admin-user-rol" required>
                            <option value="CAPTURISTA">Capturista (Registro y Edici√≥n)</option>
                            <option value="CONSULTOR">Consultor (Solo Lectura)</option>
                            <option value="ADMINISTRADOR">Administrador (Control Total)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="activo" id="admin-user-activo">
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Usuario</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;"
                            onclick="cerrarModal('modal-usuario-admin')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Organizaci√≥n -->
    <div id="modal-detalle-organizacion" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="card-title" id="detalle-org-nombre-title">Detalle de la Dependencia</h3>
                <button class="modal-close" onclick="cerrarModal('modal-detalle-organizacion')">&times;</button>
            </div>
            <div class="modal-body">
                <h2 id="detalle-org-nombre" style="color: var(--azul-institucional); margin-bottom: 20px;">Nombre</h2>
                <div class="stats-grid mb-20">
                    <div class="stat-card">
                        <div class="stat-label">Tipo</div>
                        <div id="detalle-org-tipo" class="stat-number"
                            style="font-size: 1.2rem; color: var(--azul-institucional);"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sem√°foro</div>
                        <div id="detalle-org-semaforo" class="stat-number" style="font-size: 1.2rem;"></div>
                    </div>
                </div>
                <div class="card mb-20">
                    <div class="card-header">
                        <h4 class="card-title">Informaci√≥n General</h4>
                    </div>
                    <div class="p-20">
                        <p><strong>Titular:</strong> <span id="detalle-org-titular"></span></p>
                        <p><strong>Siglas:</strong> <span id="detalle-org-siglas"></span></p>
                        <p id="container-decreto"><strong>Decreto:</strong> <a id="detalle-org-decreto" href="#"
                                target="_blank" class="btn btn-secondary btn-sm">Ver Documento üîó</a></p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Herramientas Registradas</h4>
                    </div>
                    <div id="detalle-org-herramientas-lista">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Secci√≥n de Expediente de Seguimiento -->
                <div class="card mt-20" id="detalle-org-expediente-section">
                    <div class="card-header">
                        <h4 class="card-title">üìÅ Expediente de Seguimiento</h4>
                    </div>
                    <div class="p-20" id="detalle-org-expediente-content">
                        <!-- Aqu√≠ se renderizar√° el expediente activo o el bot√≥n para crear uno -->
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Organizaci√≥n -->
    <div id="modal-editar-organizacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Editar Dependencia/Entidad</h3>
                <button class="modal-close" onclick="cerrarModal('modal-editar-organizacion')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-organizacion">
                    <input type="hidden" name="id" id="edit-org-id">
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-input" name="nombre" id="edit-org-nombre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="tipo" id="edit-org-tipo" required>
                            <option value="DEPENDENCIA">Dependencia</option>
                            <option value="ENTIDAD_PARAESTATAL">Entidad Paraestatal</option>
                            <option value="ORGANISMO_AUTONOMO">Organismo Aut√≥nomo</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Siglas</label><input type="text"
                            class="form-input" name="siglas" id="edit-org-siglas"></div>
                    <div class="form-group"><label class="form-label">Titular</label><input type="text"
                            class="form-input" name="titular" id="edit-org-titular"></div>
                    <div class="form-group"><label class="form-label">Decreto (URL)</label><input type="url"
                            class="form-input" name="decreto_creacion" id="edit-org-decreto"></div>
                    <div class="form-group">
                        <label class="form-label">¬øRequiere Manual de Servicios?</label>
                        <div style="display: flex; gap: 20px; align-items: center; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="requiere_manual_servicios" id="edit-org-manual-si"
                                    value="true" checked> S√≠
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="requiere_manual_servicios" id="edit-org-manual-no"
                                    value="false"> No
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Cambios</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;"
                            onclick="cerrarModal('modal-editar-organizacion')">Cancelar</button>
                        <button type="button" id="btn-eliminar-organizacion" class="btn btn-danger"
                            style="flex: 1; display: none; background-color: var(--rojo-semaforo);"
                            onclick="borrarOrganizacionDefinitivamente()">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Organizaci√≥n -->
    <div id="modal-nueva-organizacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Nueva Dependencia</h3>
                <button class="modal-close" onclick="cerrarModal('modal-nueva-organizacion')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-nueva-organizacion">
                    <div class="form-group"><label class="form-label">Nombre</label><input type="text"
                            class="form-input" name="nombre" required></div>
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="tipo" required>
                            <option value="DEPENDENCIA">Dependencia</option>
                            <option value="ENTIDAD_PARAESTATAL">Entidad Paraestatal</option>
                            <option value="ORGANISMO_AUTONOMO">Organismo Aut√≥nomo</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Siglas</label><input type="text"
                            class="form-input" name="siglas"></div>
                    <div class="form-group"><label class="form-label">Titular</label><input type="text"
                            class="form-input" name="titular"></div>
                    <div class="form-group"><label class="form-label">Decreto (URL)</label><input type="url"
                            class="form-input" name="decreto_creacion"></div>
                    <div class="form-group">
                        <label class="form-label">¬øRequiere Manual de Servicios?</label>
                        <div style="display: flex; gap: 20px; align-items: center; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="requiere_manual_servicios" value="true" checked> S√≠
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="requiere_manual_servicios" value="false"> No
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Guardar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Herramienta -->
    <div id="modal-nueva-herramienta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Nueva Herramienta</h3>
                <button class="modal-close" onclick="cerrarModal('modal-nueva-herramienta')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-nueva-herramienta">
                    <div class="form-group">
                        <label class="form-label">Dependencia/Entidad</label>
                        <select class="form-select" name="organizacion_id" id="select-organizacion" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Herramienta</label>
                        <select class="form-select" name="tipo_herramienta" id="select-tipo-herramienta" required
                            onchange="window.handleTipoHerramientaChange(this.value)">
                            <option value="">Seleccione...</option>
                            <option value="ORGANIGRAMA">Organigrama</option>
                            <option value="REGLAMENTO_ESTATUTO">Reglamento Interior / Estatuto Org√°nico</option>
                            <option value="MANUAL_ORGANIZACION">Manual de Organizaci√≥n</option>
                            <option value="MANUAL_PROCEDIMIENTOS">Manual de Procedimientos</option>
                            <option value="MANUAL_SERVICIOS">Manual de Servicios</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="group-nombre-personalizado">
                        <label class="form-label">Nombre espec√≠fico (Obligatorio para Manuales)</label>
                        <input type="text" class="form-input" name="nombre_personalizado"
                            id="input-nombre-personalizado" placeholder="Ej: Buen Gobierno, Fiscalizaci√≥n...">
                    </div>

                    <!-- Pregunta condicional para Manual de Servicios -->
                    <div class="form-group hidden" id="pregunta-manual-servicios">
                        <label class="form-label">¬øRequiere Manual de Servicios?</label>
                        <div style="display: flex; gap: 20px; align-items: center; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="req_manual" value="SI"
                                    onchange="window.toggleInputsManual(true)"> S√≠
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="req_manual" value="NO"
                                    onchange="window.toggleInputsManual(false)"> No
                            </label>
                        </div>
                    </div>

                    <div id="campos-herramienta-archivo">
                        <div class="form-group"><label class="form-label">Link</label><input type="url"
                                class="form-input" name="link_publicacion_poe" id="input-link-herramienta"
                                placeholder="https://..."></div>
                        <div class="form-group"><label class="form-label">Archivo (Opcional)</label><input type="file"
                                class="form-input" name="archivo" id="input-archivo-herramienta"></div>
                        <div class="form-group"><label class="form-label">Fecha</label><input type="date"
                                class="form-input" name="fecha_emision" id="input-fecha-herramienta" required></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Guardar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Herramienta -->
    <div id="modal-editar-herramienta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Editar Herramienta</h3>
                <button class="modal-close" onclick="cerrarModal('modal-editar-herramienta')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-herramienta" onsubmit="window.guardarCambiosHerramienta(event)">
                    <input type="hidden" name="id" id="edit-herramienta-id">
                    <div class="form-group">
                        <label class="form-label">Dependencia/Entidad</label>
                        <select class="form-select" name="organizacion_id" id="edit-herramienta-org-id">
                            <!-- Inyectado por JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Herramienta</label>
                        <select class="form-select" name="tipo_herramienta" id="edit-herramienta-tipo" required
                            onchange="window.handleTipoHerramientaChangeEdit(this.value)">
                            <option value="ORGANIGRAMA">Organigrama</option>
                            <option value="REGLAMENTO_ESTATUTO">Reglamento Interior / Estatuto Org√°nico</option>
                            <option value="MANUAL_ORGANIZACION">Manual de Organizaci√≥n</option>
                            <option value="MANUAL_PROCEDIMIENTOS">Manual de Procedimientos</option>
                            <option value="MANUAL_SERVICIOS">Manual de Servicios</option>
                        </select>
                    </div>

                    <div class="form-group" id="edit-group-nombre-personalizado">
                        <label class="form-label">Nombre espec√≠fico</label>
                        <input type="text" class="form-input" name="nombre_personalizado"
                            id="edit-herramienta-nombre-personalizado"
                            placeholder="Ej: Buen Gobierno, Fiscalizaci√≥n...">
                    </div>
                    <div class="form-group"><label class="form-label">Link</label><input type="url" class="form-input"
                            name="link_publicacion_poe" id="edit-herramienta-link" placeholder="https://..."></div>
                    <div class="form-group"><label class="form-label">Archivo</label><input type="file"
                            class="form-input" name="archivo" id="edit-herramienta-archivo"></div>
                    <div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input"
                            name="fecha_emision" id="edit-herramienta-fecha" required></div>

                    <div class="form-group">
                        <label class="form-label">Estatus POE</label>
                        <input type="text" class="form-input" name="estatus_poe" id="edit-herramienta-estatus"
                            placeholder="Ej. Publicado, En tr√°mite">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Versi√≥n</label>
                        <input type="text" class="form-input" name="version" id="edit-herramienta-version"
                            placeholder="1.0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Comentarios</label>
                        <textarea class="form-input" name="comentarios" id="edit-herramienta-comentarios"
                            rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Actualizar</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;"
                            onclick="cerrarModal('modal-editar-herramienta')">Cancelar</button>
                        <button type="button" class="btn btn-danger" style="flex: 1;"
                            onclick="borrarHerramientaDefinitivamente()">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Expediente -->
    <div id="modal-nuevo-expediente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Nuevo Expediente</h3>
                <button class="modal-close" onclick="cerrarModal('modal-nuevo-expediente')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-expediente" onsubmit="window.handleCrearExpediente(event)">
                    <div class="form-group">
                        <label class="form-label">T√≠tulo del Proyecto</label>
                        <input type="text" class="form-input" name="titulo" required
                            placeholder="Ej: Reestructuraci√≥n 2024">
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√∫mero de Expediente</label>
                        <input type="text" class="form-input" name="numero_expediente" required
                            placeholder="EXP-2024-001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dependencia/Entidad</label>
                        <select class="form-select" name="organizacion_id" id="select-organizacion-expediente" required>
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioridad</label>
                        <select class="form-select" name="prioridad">
                            <option value="BAJA">Baja</option>
                            <option value="MEDIA">Media</option>
                            <option value="ALTA">Alta</option>
                            <option value="URGENTE">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-input" name="descripcion" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Crear Expediente</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Expediente -->
    <div id="modal-detalle-expediente" class="modal">
        <div class="modal-content modal-xl-custom">
            <div class="modal-header">
                <div>
                    <h3 class="card-title" id="detalle-exp-titulo" style="font-size: 1.5rem;">Detalle del Expediente
                    </h3>
                    <small id="detalle-exp-subtitulo" class="text-muted" style="font-size: 1rem;">Cargando...</small>
                </div>
                <button class="modal-close" onclick="cerrarModal('modal-detalle-expediente')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tabs sutiles (Texto en lugar de botones) -->
                <div class="tabs-subtle">
                    <button class="tab-link active"
                        onclick="window.ExpedientesModule.switchTab(event, 'tab-bitacora')">Bit√°cora de
                        Avances</button>
                    <button class="tab-link" onclick="window.ExpedientesModule.switchTab(event, 'tab-info')">Informaci√≥n
                        General</button>
                </div>

                <!-- Tab Avances -->
                <div id="tab-bitacora" class="tab-content active">
                    <!-- Formulario Nuevo Avance -->
                    <div id="form-avance-container" class="card bg-light mb-20" style="display: none;">
                        <form id="form-nuevo-avance" onsubmit="window.ExpedientesModule.handleAgregarAvance(event)">
                            <div class="form-group">
                                <label class="form-label">Nuevo Movimiento</label>
                                <input type="text" class="form-input" name="titulo"
                                    placeholder="T√≠tulo del avance (ej. Reuni√≥n con Director)" required>
                            </div>
                            <div class="row">
                                <div class="col" style="flex: 1;">
                                    <select class="form-select" name="tipo">
                                        <option value="AVANCE">Avance General</option>
                                        <option value="REUNION">Reuni√≥n</option>
                                        <option value="OFICIO">Oficio / Documento</option>
                                        <option value="OTRO">Otro</option>
                                    </select>
                                </div>
                                <div class="col" style="flex: 1;">
                                    <input type="date" class="form-input" name="fecha" required>
                                </div>
                            </div>
                            <div class="form-group mt-10">
                                <textarea class="form-input" name="descripcion" rows="2"
                                    placeholder="Detalles adicionales..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary">Registrar Avance</button>
                        </form>
                    </div>

                    <!-- Timeline -->
                    <div class="timeline" id="expediente-timeline">
                        <!-- Items inyectados por JS -->
                        <p class="text-center text-muted">Cargando historial...</p>
                    </div>
                </div>

                <!-- Tab Info -->
                <div id="tab-info" class="tab-content">
                    <div id="expediente-info-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.ExpedientesModule.descargarPDF()">üìÑ Descargar Reporte
                    PDF</button>
                <button class="btn btn-primary" onclick="cerrarModal('modal-detalle-expediente')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Reporte de Prioridades -->
    <div id="modal-reporte-prioridades" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="card-title">üìä Reporte de Expedientes por Prioridad</h3>
                <button class="modal-close" onclick="cerrarModal('modal-reporte-prioridades')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="reporte-prioridades-content">
                    <p class="text-center text-muted">Cargando...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-reporte-prioridades')">Cerrar</button>
            </div>
        </div>
    </div>


    <!-- Modal Importar Excel -->
    <div id="modal-importar-excel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title" id="import-modal-title">Importar Excel</h3>
                <button class="modal-close" onclick="cerrarModal('modal-importar-excel')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-importar-excel" onsubmit="window.handleImportarExcel(event)">
                    <input type="hidden" id="import-type" name="tipo">

                    <p class="mb-10" id="import-instructions">Instrucciones...</p>

                    <div class="form-group">
                        <label class="form-label">Plantilla</label>
                        <a href="#" id="btn-descargar-plantilla" class="btn btn-secondary btn-sm"
                            style="text-decoration: none;">
                            ‚¨áÔ∏è Descargar Plantilla
                        </a>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Columnas Requeridas</label>
                        <ul id="import-columns-list" style="font-size: 0.85rem; color: #666; padding-left: 20px;"></ul>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Archivo Excel (.xlsx)</label>
                        <input type="file" class="form-input" id="import-file" accept=".xlsx, .xls" required>
                    </div>

                    <div id="import-status" style="display: none; margin-bottom: 10px;">
                        <div class="spinner"></div> Procesando...
                    </div>

                    <div id="import-results" class="mb-10"></div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary"
                            onclick="cerrarModal('modal-importar-excel')">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-import-submit">üì§ Importar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Reporte de Prioridades de Expedientes -->
    <div id="modal-reporte-prioridades" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">üìä Reporte de Prioridades de Expedientes</h3>
                <button type="button" class="btn-close" onclick="cerrarModal('modal-reporte-prioridades')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="reporte-prioridades-content">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="cerrarModal('modal-reporte-prioridades')">Cerrar</button>
            </div>
        </div>
    </div>




    <!-- Modal Smart Search (Spotlight) -->
    <div id="modal-search-spotlight" class="modal-search-overlay" style="display: none;">
        <div class="modal-search-container">
            <div class="search-header">
                <span class="search-icon">üîç</span>
                <input type="text" id="spotlight-input" placeholder="Buscar dependencia, herramienta, expediente..."
                    autocomplete="off">
                <span class="esc-hint">ESC para cerrar</span>
            </div>
            <div class="search-body">
                <div id="spotlight-results" class="search-results-list">
                    <!-- Resultados din√°micos -->
                    <div class="search-empty-state">
                        <p>Escribe para buscar en todo el sistema...</p>
                        <small>Prueba: "Secretar√≠a", "Organigrama", "Expediente 001"</small>
                    </div>
                </div>
            </div>
            <div class="search-footer">
                <span>Use las flechas ‚¨Ü‚¨á para navegar</span>
                <span>ENTER para seleccionar</span>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="assets/js/utils.js?v=2.4"></script>
    <script src="assets/js/auth.js?v=2.4"></script>
    <script src="assets/js/organizaciones.js?v=2.4"></script>
    <script src="assets/js/herramientas.js?v=2.4"></script>
    <script src="assets/js/reportes.js?v=2.4"></script>
    <script src="assets/js/usuarios.js?v=2.4"></script>
    <script src="assets/js/import.js?v=2.4"></script>
    <script src="assets/js/expedientes.js?v=2.4"></script>
    <script src="assets/js/search.js?v=2.4"></script>
    <script src="assets/js/dashboard-kpis.js?v=2.4"></script>
    <script src="assets/js/app.js?v=2.4"></script>
</body>

</html>